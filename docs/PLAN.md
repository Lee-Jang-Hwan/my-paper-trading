# OUR Paper Trading - 모의 주식 트레이딩 서비스 종합 계획서

> **프로젝트명**: OUR Paper Trading
> **버전**: v0.1 (1차 구현)
> **작성일**: 2026-02-12
> **목표**: 실시간 국내 주식시장과 동기화된 모의 투자 플랫폼 + AI 에이전트 기반 투자 지원 시스템

---

## 1. 프로젝트 개요

### 1.1 핵심 컨셉
- **실시간 싱크로**: 한국투자증권 OpenAPI를 통해 실제 국내 주식시장과 실시간 동기화
- **AI 에이전트 팀**: 게임형 캐릭터 + 상세 리포트 하이브리드 방식의 AI 어드바이저
- **딥러닝 진화**: 데이터 축적을 통해 점점 더 정교한 투자 인사이트 제공
- **모의 투자**: 실제 돈 없이 실전과 동일한 트레이딩 경험

### 1.2 기술 스택 요약

| 영역 | 기술 |
|------|------|
| **프론트엔드** | Next.js 14+ (App Router), TypeScript, TailwindCSS, Zustand |
| **실시간 통신** | WebSocket (한투 API 실시간), Supabase Realtime (DB 변경 알림) |
| **백엔드 API** | Python FastAPI |
| **AI/LLM** | Google Gemini API (계층별 모델 혼용 — 아래 3.11 참조) |
| **딥러닝** | PyTorch (LSTM, Transformer, CNN) |
| **데이터베이스** | Supabase (PostgreSQL 메인 + pgvector), Redis (실시간 캐시) |
| **주식 데이터** | 한국투자증권 OpenAPI |
| **뉴스/공시 데이터** | Naver/Daum 크롤링 + DART OpenAPI (전자공시) |
| **인증** | Clerk (이메일/비밀번호 + 소셜 로그인) |
| **에이전트 애니메이션** | Framer Motion (React), Lottie (스프라이트), PixiJS (2D 월드) |
| **임베딩/벡터검색** | Sentence-Transformers + Supabase pgvector |
| **배포** | Docker Compose (개발), Vercel (프론트) + Oracle Cloud Always Free (백엔드) |

---

## 2. 시스템 아키텍처

### 2.1 전체 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                        CLIENT (Next.js)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────────────┐  │
│  │ 트레이딩  │ │ AI Agent │ │  차트/   │ │   포트폴리오      │  │
│  │   화면    │ │   패널   │ │  호가창  │ │   대시보드        │  │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └───────┬───────────┘  │
│       └─────────────┴────────────┴───────────────┘              │
│                          │ WebSocket + REST                     │
└──────────────────────────┼──────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                    API GATEWAY (FastAPI)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ Trading  │ │ Market   │ │Clerk JWT │ │  Portfolio       │   │
│  │ Service  │ │ Data Svc │ │검증(JWKS)│ │  Service         │   │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └──────┬───────────┘   │
└───────┼─────────────┼────────────┼──────────────┼───────────────┘
        │             │            │              │
┌───────┼─────────────┼────────────┼──────────────┼───────────────┐
│       │        AI AGENT LAYER                   │               │
│  ┌────┴─────┐ ┌─────┴────┐ ┌────┴─────┐ ┌─────┴──────────┐    │
│  │ 동향분석 │ │ 투자자문 │ │ 뉴스캐치 │ │ 포트폴리오     │    │
│  │ Agent    │ │ Agent    │ │ Agent    │ │ 최적화 Agent   │    │
│  │ "한눈이" │ │ "슬기"   │ │ "번개"   │ │ "밸런스"       │    │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └──────┬──────────┘    │
│       └─────────────┴────────────┴──────────────┘               │
│                          │ Gemini 3 API                         │
└──────────────────────────┼──────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                    DEEP LEARNING LAYER                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ 주가예측 │ │ 패턴인식 │ │ 감성분석 │ │ 포트폴리오      │   │
│  │ LSTM/    │ │ CNN/     │ │ KoBERT/  │ │ 강화학습        │   │
│  │ Transf.  │ │ ResNet   │ │ KoELECTRA│ │ PPO/A2C         │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                    DATA LAYER                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ Supabase │ │ Redis    │ │ Supabase │ │ 한투 OpenAPI     │   │
│  │(Postgres)│ │ 실시간   │ │pgvector  │ │ 실시간 시세     │   │
│  │사용자/잔고│ │ 캐시/큐  │ │메모리검색│ │ + WebSocket     │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 흐름

```
한투 OpenAPI ──WebSocket──▶ Market Data Service ──▶ Redis (실시간 캐시)
                                    │                      │
                                    ▼                      ▼
                            Supabase DB       Supabase Realtime ──▶ Client
                          (시계열 파티션)    (DB변경 알림/포트폴리오)
                                            FastAPI WebSocket ──▶ Client
                                            (고빈도 시세 스트리밍)
                                    │
                                    ▼
                           DL 모델 학습/추론
                                    │
                                    ▼
                           AI Agent 분석 ──▶ Gemini 3 ──▶ 리포트 생성
```

---

## 3. AI 에이전트 시스템 (Generative Agents 아키텍처)

> **영감**: Stanford의 "Generative Agents: Interactive Simulacra of Human Behavior" 논문 기반.
> 에이전트들이 단순히 정보를 표시하는 것이 아니라, **자율적으로 움직이고, 관찰하고,
> 서로 의견을 교환하며, 기억하고, 계획을 세우는** 살아있는 존재처럼 동작합니다.

### 3.1 에이전트 코어 아키텍처

각 에이전트는 Stanford Generative Agents 아키텍처를 주식 트레이딩 도메인에 맞게 적용한
3가지 핵심 모듈을 가집니다.

#### 3.1.1 메모리 스트림 (Memory Stream)

각 에이전트는 자신이 경험한 모든 것을 자연어로 기록하는 장기 메모리를 보유합니다.

```
메모리 스트림 구조:
┌─────────────────────────────────────────────────────────┐
│ Memory Stream (시간순 기록)                               │
│                                                          │
│ [09:01] 관찰: KOSPI가 2,650에서 장 시작, 갭상승 +0.8%   │
│ [09:03] 관찰: 삼성전자 시가 72,500원, 거래량 폭증       │
│ [09:05] 대화: 번개가 "반도체 수출 호조 속보" 전달함      │
│ [09:07] 반성: 반도체 섹터 전체가 상승 중, 수출 뉴스 영향 │
│ [09:10] 대화: 슬기에게 "삼성전자 분석 요청" 전달함       │
│ [09:15] 관찰: 외국인 순매수 500억 유입                   │
│ ...                                                      │
└─────────────────────────────────────────────────────────┘
```

**메모리 검색 (Retrieval)** — 3가지 점수의 가중합으로 관련 기억 검색:

| 점수 | 계산 방식 | 예시 |
|------|-----------|------|
| **최근성 (Recency)** | 지수 감쇠 함수 (decay=0.995), 최근 기억일수록 높은 점수 | 1분 전 관찰 > 2시간 전 관찰 |
| **중요도 (Importance)** | LLM이 1~10점 부여, 일상적 관찰(1) vs 속보/급등락(10) | "KOSPI +0.1%" → 2점, "삼성전자 실적 서프라이즈" → 9점 |
| **관련성 (Relevance)** | 현재 상황과의 코사인 유사도 (임베딩 벡터 비교) | "반도체" 질문 시 반도체 관련 기억 높은 점수 |

```
최종 검색 점수 = α_recency × 최근성 + α_importance × 중요도 + α_relevance × 관련성
(각 점수는 [0,1]로 정규화)
```

#### 3.1.2 리플렉션 (Reflection) — 고수준 통찰 생성

에이전트가 축적된 기억에서 **상위 수준의 인사이트**를 자동 생성하는 메커니즘.
중요도 점수의 합이 임계값을 초과하면 리플렉션이 트리거됩니다.

```
리플렉션 프로세스:
최근 메모리 중요도 합산 ─▶ 임계값 초과? ─▶ YES ─▶ 리플렉션 생성
                                            │
                                            ▼
                         최근 100개 메모리에서 핵심 질문 3개 도출
                                            │
                                            ▼
                         각 질문에 대해 관련 메모리 검색 + 통찰 생성
                                            │
                                            ▼
                         생성된 통찰을 메모리 스트림에 다시 저장
```

**예시 — 한눈이의 리플렉션**:
```
[축적된 메모리들]
- "09:00 반도체 섹터 +2.3% 상승"
- "09:30 번개가 TSMC 증설 뉴스 전달"
- "10:00 외국인 반도체 순매수 1,200억"
- "10:30 삼성전자 거래량 전일 대비 300% 증가"

[리플렉션 트리거 → 질문 생성]
Q1: "오늘 반도체 섹터에 무슨 일이 벌어지고 있는가?"
Q2: "외국인 수급의 방향성은 무엇을 의미하는가?"

[생성된 통찰]
→ "TSMC 증설 뉴스를 기점으로 외국인이 반도체 섹터에 강한 매수세를 보이고 있다.
   이는 단기 모멘텀이 아닌 산업 구조적 호재로 판단되며,
   삼성전자/SK하이닉스의 추가 상승 여력이 있다."
```

**리플렉션 빈도**: 장중 약 2~3회 (시장 변동성에 따라 유동적)

#### 3.1.3 계획 (Planning) — 자율적 행동 스케줄링

에이전트가 장 시작 전 하루 계획을 세우고, 실시간 상황에 따라 재계획합니다.

```
3단계 계획 구조:

[1단계] 대략적 일일 계획 (장 시작 전)
  ├── 08:30~09:00  프리마켓 분석, 전일 해외시장 리뷰
  ├── 09:00~09:30  장 초반 시장 방향성 파악
  ├── 09:30~11:30  섹터별 동향 심층 분석
  ├── 11:30~12:30  오전장 요약 리포트 작성
  ├── 12:30~14:00  오후장 모니터링 + 이상 신호 감지
  ├── 14:00~15:20  장 마감 대비 종합 분석
  └── 15:20~15:30  장 마감 리뷰 + 내일 전망

[2단계] 시간 단위 분해
  09:00~09:30 →
    ├── 09:00~09:05  KOSPI/KOSDAQ 시가 확인, 갭 분석
    ├── 09:05~09:10  거래량 상위 종목 스캔
    ├── 09:10~09:20  외국인/기관 초반 수급 확인
    └── 09:20~09:30  초반 동향 말풍선으로 사용자에게 전달

[3단계] 실시간 반응적 재계획
  새로운 관찰 발생 → "이것에 반응해야 하는가?" 판단
  → YES: 현재 계획 중단 → 긴급 분석 → 에이전트 간 협업 트리거
  → NO: 기존 계획 계속 진행
```

### 3.2 에이전트 목록 및 역할

#### Agent 1: "한눈이" (동향 분석 에이전트)
- **역할**: 시장 전체 흐름 파악 및 섹터별 동향 분석
- **성격**: 차분하고 객관적. 데이터를 기반으로 말하며 감정적 판단을 경계함
- **기능**:
  - KOSPI/KOSDAQ 지수 실시간 모니터링 및 해석
  - 섹터별 등락률 분석 (반도체, 바이오, 2차전지 등)
  - 외국인/기관 수급 동향 추적
  - 거래량 이상 감지 및 알림
  - 시장 심리 지수(공포/탐욕) 산출
- **DL 연동**: 주가 예측 모델 + 패턴 인식 결과 활용
- **캐릭터**: 돋보기를 든 분석가, 안경 착용, 차트 자료를 들고 다님
- **위치 패턴**: 주로 시장 전광판 앞에서 서성이며 데이터 관찰

#### Agent 2: "슬기" (투자 자문 에이전트)
- **역할**: 개별 종목 분석 및 매수/매도 추천
- **성격**: 신중하고 근거 기반. 항상 수치와 함께 설명하며, 확신이 없으면 솔직히 말함
- **기능**:
  - 종목별 기본적 분석 (PER, PBR, ROE 등 재무지표)
  - 기술적 분석 (이동평균, RSI, MACD, 볼린저밴드)
  - 매수/매도/관망 의견 제시 (신뢰도 %)
  - 목표가 및 손절가 제안
  - 사용자 포트폴리오 기반 맞춤 추천
- **DL 연동**: 4가지 DL 모델 종합 결과 기반 추천
- **캐릭터**: 정장 입은 전문 애널리스트, 태블릿을 들고 다님
- **위치 패턴**: 종목 분석 데스크에서 작업하다가 다른 에이전트에게 걸어가서 의견 교환

#### Agent 3: "번개" (뉴스 캐치 에이전트)
- **역할**: 실시간 뉴스/공시/속보 모니터링 및 영향 분석
- **성격**: 빠르고 간결함. 속보에 민감하며 항상 바삐 움직임. 가끔 흥분하기도 함
- **기능**:
  - 실시간 증권 뉴스 크롤링 (Naver/Daum)
  - 속보 감지 및 즉시 알림 (팝업 + 말풍선)
  - 뉴스 영향도 분석 (호재/악재/중립 판단)
  - 관련 종목 자동 매핑
  - 공시 정보 해석 (유상증자, 실적발표, M&A 등)
  - 일일 뉴스 브리핑 리포트 생성
- **DL 연동**: NLP 감성 분석 모델로 뉴스 감성 점수 산출
- **캐릭터**: 헤드셋 쓴 기자, 마이크와 신문을 들고 바삐 뛰어다님
- **위치 패턴**: 뉴스 터미널과 다른 에이전트 사이를 분주하게 왔다갔다

#### Agent 4: "밸런스" (포트폴리오 최적화 에이전트)
- **역할**: 사용자 포트폴리오 관리 및 리스크 최적화
- **성격**: 안정적이고 신중. 리스크를 항상 먼저 생각하며, 슬기와 자주 토론함
- **기능**:
  - 현재 포트폴리오 리스크 진단
  - 자산 배분 최적화 제안 (마코위츠 + RL)
  - 분산투자 가이드
  - 수익률/손실률 분석 리포트
  - 리밸런싱 타이밍 알림
- **DL 연동**: 강화학습 기반 포트폴리오 최적화 모델
- **캐릭터**: 저울을 든 균형잡힌 캐릭터, 계산기와 차트를 번갈아 봄
- **위치 패턴**: 포트폴리오 보드 앞에서 고민하다가 슬기를 찾아가 토론

### 3.3 에이전트 자율 행동 시스템 (Autonomous Behavior)

에이전트들은 고정된 위치에 있는 것이 아니라, **실시간으로 이동하고 행동하며
서로를 찾아가 대화**합니다. Stanford Generative Agents의 핵심인
"관찰→반응→계획→행동" 루프를 주식 도메인에 적용합니다.

#### 3.3.1 에이전트 행동 루프 (10초 간격)

```
매 틱(~10초)마다 각 에이전트가 실행하는 루프:

  ┌─────────────────────────────────────────────────┐
  │                 PERCEPTION (관찰)                 │
  │  현재 시장 데이터 + 주변 에이전트 상태 인식       │
  └────────────────────┬────────────────────────────┘
                       ▼
  ┌─────────────────────────────────────────────────┐
  │              RETRIEVAL (기억 검색)                │
  │  관찰 내용과 관련된 메모리 상위 N개 검색          │
  └────────────────────┬────────────────────────────┘
                       ▼
  ┌─────────────────────────────────────────────────┐
  │               REACT (반응 결정)                   │
  │  "이 관찰에 반응해야 하는가?" → LLM 판단         │
  │  YES → 현재 계획 수정 + 행동 생성                │
  │  NO  → 기존 계획 계속 수행                       │
  └────────────────────┬────────────────────────────┘
                       ▼
  ┌─────────────────────────────────────────────────┐
  │               ACTION (행동 실행)                  │
  │  이동 / 분석 수행 / 다른 에이전트에게 말 걸기 /   │
  │  사용자에게 알림 / 리포트 작성                    │
  └────────────────────┬────────────────────────────┘
                       ▼
  ┌─────────────────────────────────────────────────┐
  │              MEMORY (기억 저장)                    │
  │  이번 관찰 + 행동 결과를 메모리 스트림에 기록      │
  └─────────────────────────────────────────────────┘
```

#### 3.3.2 에이전트 행동 유형

| 행동 | 시각적 표현 | 설명 |
|------|------------|------|
| **이동 (Move)** | 스프라이트가 목적지로 걸어감 | 다른 에이전트/장소로 이동 |
| **분석 (Analyze)** | 캐릭터 위에 차트/돋보기 아이콘 | 데이터 분석 중 |
| **대화 (Talk)** | 두 캐릭터가 마주보며 말풍선 교환 | 에이전트 간 의견 교환 |
| **알림 (Alert)** | 캐릭터가 사용자 쪽으로 뛰어오며 느낌표 | 긴급 정보 전달 |
| **작성 (Write)** | 캐릭터가 책상에서 타이핑 애니메이션 | 리포트 작성 중 |
| **고민 (Think)** | 캐릭터 위에 물음표/전구 아이콘 | 리플렉션/판단 중 |
| **흥분 (Excited)** | 캐릭터가 점프/빛남 효과 | 중요 발견/속보 감지 |
| **경고 (Warn)** | 캐릭터가 빨간 깃발을 들어올림 | 리스크 경고 |

### 3.4 에이전트 간 대화 시스템 (Agent-to-Agent Conversation)

에이전트들이 서로를 인식하고 **자율적으로 대화를 시작**하는 것이 핵심 기능입니다.
사용자는 이 대화를 실시간으로 관찰하며 투자 판단에 참고합니다.

#### 3.4.1 대화 트리거 조건

```
대화 시작 조건:
1. 근접성: 에이전트가 같은 영역에 있을 때
2. 관련성: 한 에이전트가 다른 에이전트의 전문 영역과 관련된 정보를 발견했을 때
3. 긴급성: 속보/급등락 등 중요 이벤트 발생 시 (강제 소집)
4. 주기적: 정기 미팅 시간 (장 시작 전, 점심, 장 마감 전)

대화 결정 프로세스:
번개가 속보를 감지
  → "이 뉴스를 누구에게 알려야 하는가?" (LLM 판단)
  → "한눈이에게 시장 영향 분석 요청" 결정
  → 번개가 한눈이에게 걸어감 (이동 애니메이션)
  → 대화 시작 (말풍선 교환)
```

#### 3.4.2 대화 시나리오 예시

**시나리오 1: 속보 → 연쇄 분석**
```
[09:32] 번개 (뛰어오며): "속보! 삼성전자 4분기 영업이익 12조,
                          컨센서스 대비 +15% 서프라이즈!"
         → 번개가 한눈이에게 달려감 (이동 애니메이션)

[09:33] 번개 → 한눈이:
        번개: "한눈이, 삼성전자 실적 서프라이즈야! 반도체 섹터 어떻게 봐?"
        한눈이: "외국인 수급이 이미 유입 중이었는데, 이 뉴스면 추가 상승
                 동력이 될 수 있어. 반도체 장비주까지 수혜 예상돼."
        번개: "고마워, 슬기한테도 알려줘야겠다!"
         → 번개가 슬기에게 뛰어감

[09:34] 번개 → 슬기:
        번개: "슬기! 삼성전자 실적 서프라이즈, 한눈이도 반도체 추가 상승 예상해!"
        슬기: "확인했어. 삼성전자 현재 RSI 55, 아직 과매수 아니니까
               단기 목표가 75,000원 설정해볼게. 밸런스한테도 물어보자."
         → 슬기가 밸런스에게 걸어감

[09:35] 슬기 → 밸런스:
        슬기: "밸런스, 삼성전자 추가 매수 어떻게 생각해?
               실적 서프라이즈에 기술적으로도 여유 있어."
        밸런스: "현재 포트폴리오에서 삼성전자 비중이 15%인데,
                20%까지는 괜찮을 것 같아. 다만 반도체 섹터 전체 비중이
                35% 넘어가면 분산 리스크가 커져. 신중하게 접근하자."

         → 사용자에게 종합 알림 전달:
         "4명의 에이전트가 삼성전자 실적 서프라이즈를 분석했습니다.
          [상세 보기]를 클릭하면 전체 대화 내용과 종합 의견을 확인할 수 있습니다."
```

**시나리오 2: 의견 충돌 (토론)**
```
[14:00] 슬기 → 밸런스:
        슬기: "카카오 RSI 28까지 떨어졌어. 기술적으로 과매도 구간이라
               반등 가능성이 높아 보여."
        밸런스: "음... 하지만 현재 포트폴리오에 성장주 비중이 이미 40%야.
                카카오를 추가하면 성장주 편중이 심해져. 반등하더라도
                리스크 대비 수익이 불리해."
        슬기: "좋은 지적이야. 그럼 기존 성장주 일부를 정리하고
               카카오로 교체하는 건 어때?"
        밸런스: "그 방향이면 괜찮을 수 있어. 한눈이한테 카카오 섹터
                전체 흐름도 확인해보자."
         → 밸런스가 한눈이를 찾아감

         → 사용자에게 알림:
         "슬기와 밸런스가 카카오 매수에 대해 토론 중입니다.
          의견이 갈리고 있어요. [토론 보기]"
```

**시나리오 3: 정기 미팅 (장 시작 전)**
```
[08:45] 4명의 에이전트가 중앙 미팅 테이블에 모임

        한눈이: "어제 미국장 나스닥 +1.2% 마감, 선물도 강세.
                 오늘 갭업 출발 예상돼."
        번개: "오늘 주요 일정으로 한국은행 기준금리 결정이 14시에 있어.
               시장 변동성 높을 수 있어."
        슬기: "어제 DL 모델 예측에 따르면 KOSPI 상승 확률 65%.
               주목 종목은 삼성전자, LG에너지솔루션."
        밸런스: "현재 포트폴리오 현금 비중 30%. 오늘 금리 결정 전까지는
                보수적 접근 추천. 금리 결정 후 방향 잡자."

         → 사용자에게 [오전 브리핑] 리포트 자동 생성
```

#### 3.4.3 대화 생성 메커니즘 (기술 구현)

```python
# 대화 생성 프로세스 (의사코드)
def generate_conversation(initiator, target, topic):
    # 1. 대화 시작자의 관련 메모리 검색
    initiator_memories = initiator.memory.retrieve(topic, k=10)

    # 2. 대화 상대의 관련 메모리 검색
    target_memories = target.memory.retrieve(topic, k=10)

    # 3. LLM으로 대화 생성 (턴제)
    conversation = []
    for turn in range(max_turns):
        if turn % 2 == 0:  # 시작자 턴
            utterance = llm.generate(
                speaker=initiator.persona,
                memories=initiator_memories,
                conversation_history=conversation,
                prompt="시장 상황과 기억을 바탕으로 자연스럽게 응답하세요."
            )
        else:  # 상대방 턴
            utterance = llm.generate(
                speaker=target.persona,
                memories=target_memories,
                conversation_history=conversation,
                prompt="상대의 의견에 동의/반박하며 전문적 관점을 제시하세요."
            )
        conversation.append(utterance)

        # 4. 대화 종료 조건 판단
        if llm.should_end_conversation(conversation):
            break

    # 5. 대화 내용을 양쪽 메모리에 저장
    initiator.memory.add(conversation, type="conversation")
    target.memory.add(conversation, type="conversation")

    # 6. 대화 결론 도출 → 사용자 리포트 생성
    conclusion = llm.summarize_conclusion(conversation)
    return conversation, conclusion
```

### 3.5 에이전트 시각적 월드 (Agent World View)

에이전트들이 활동하는 **미니 월드 맵**이 트레이딩 화면 내에 배치됩니다.
에이전트들은 이 맵 위에서 실시간으로 이동하고 상호작용합니다.

#### 3.5.1 에이전트 월드 맵 구조

```
┌─────────────────────────────────────────────────────────────┐
│  에이전트 월드 (Agent World) — 트레이딩 화면 좌측 또는 하단   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                                                       │   │
│  │   📺 시장 전광판        📋 분석 데스크                │   │
│  │   ┌─────────┐          ┌─────────┐                   │   │
│  │   │ KOSPI   │          │         │     📰 뉴스       │   │
│  │   │ 2,650▲  │  🔍      │  📊     │     터미널        │   │
│  │   │ +0.8%   │ 한눈이   │  슬기   │    ┌──────┐      │   │
│  │   └─────────┘  (관찰중) │ (분석중) │    │      │      │   │
│  │                         └─────────┘    │  ⚡   │      │   │
│  │      💬"반도체                          │ 번개  │      │   │
│  │       강세 지속"    ─ ─ ─ ─ ─ ─ ─ ─▶  │(크롤링)│      │   │
│  │                    (걸어가는 중...)      └──────┘      │   │
│  │                                                       │   │
│  │   🗣️ 미팅 테이블          ⚖️ 포트폴리오 보드          │   │
│  │   ┌─────────┐          ┌─────────────┐               │   │
│  │   │ ○  ○    │          │ 보유종목    │               │   │
│  │   │  테이블  │          │ 삼성전자 15%│  ⚖️           │   │
│  │   │ ○  ○    │          │ SK하이닉 10%│  밸런스        │   │
│  │   └─────────┘          │ ...         │  (리밸런싱     │   │
│  │   (정기 미팅 장소)      └─────────────┘   검토중)      │   │
│  │                                                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  [대화 로그]                                                 │
│  09:32 ⚡번개 → 🔍한눈이: "속보! 삼성전자 실적 서프라이즈!" │
│  09:33 🔍한눈이 → 📊슬기: "반도체 추가 상승 동력 있어"      │
│  09:34 📊슬기 → ⚖️밸런스: "삼성전자 추가 매수 어떨까?"      │
│  [전체 대화 보기 ▼]                                         │
└─────────────────────────────────────────────────────────────┘
```

#### 3.5.2 맵 장소 및 의미

| 장소 | 기능 | 방문 에이전트 |
|------|------|--------------|
| **시장 전광판** | KOSPI/KOSDAQ 실시간 지수 표시 | 한눈이 (상주), 모두 (확인차) |
| **분석 데스크** | 종목 상세 분석 작업 공간 | 슬기 (상주), 한눈이 (데이터 전달) |
| **뉴스 터미널** | 실시간 뉴스 피드 수신 | 번개 (상주), 모두 (속보 시) |
| **포트폴리오 보드** | 사용자 보유 현황 표시 | 밸런스 (상주), 슬기 (추천 반영) |
| **미팅 테이블** | 에이전트 정기/긴급 회의 | 모두 (정기 미팅, 긴급 소집) |
| **사용자 데스크** | 사용자에게 직접 보고 | 알림 전달 시 해당 에이전트 방문 |

#### 3.5.3 이동 및 애니메이션 시스템

```
에이전트 시각 표현:
- 캐릭터: 32x32 ~ 64x64 픽셀 스프라이트 (또는 Lottie 벡터 애니메이션)
- 이동: CSS transform + transition (부드러운 이동)
- 상태 이모지: 캐릭터 위에 현재 행동 아이콘 표시
  - 📖 분석 중  |  💬 대화 중  |  🏃 이동 중  |  ⚠️ 경고
  - 💡 통찰 발견  |  ✍️ 리포트 작성  |  😲 속보 감지

이동 애니메이션:
- 걷기: 2프레임 스프라이트 애니메이션 (좌/우/상/하)
- 뛰기: 속보/긴급 시 빠른 이동 + 먼지 이펙트
- 도착: 목적지 도착 시 잠깐 멈춤 → 행동 시작
- 대화: 두 캐릭터가 마주보는 방향으로 전환
```

### 3.6 에이전트 간 정보 확산 메커니즘

Stanford Generative Agents에서 Valentine's Day 파티 초대가 마을 전체로
퍼져나간 것처럼, 우리 에이전트들도 정보가 자연스럽게 확산됩니다.

```
정보 확산 흐름 예시:

[T+0초]  번개가 속보 감지
           │
[T+10초] 번개 → 한눈이에게 전달 (뉴스 내용 + 감성 점수)
           │
[T+30초] 한눈이가 시장 영향 분석 완료 → 슬기에게 전달
           │
[T+50초] 슬기가 종목 분석 완료 → 밸런스에게 전달 + 사용자에게 1차 알림
           │
[T+70초] 밸런스가 포트폴리오 영향 분석 완료
           │
[T+80초] 전체 종합 리포트 생성 → 사용자에게 최종 알림

  ※ 정보의 중요도에 따라 확산 속도 조절:
  - 속보/급등락: 즉시 전파 (번개가 뛰어다님)
  - 일반 분석: 자연스러운 속도 (걸어서 전달)
  - 정기 리포트: 미팅 테이블에서 공유
```

### 3.7 에이전트-사용자 상호작용

#### 3.7.1 사용자가 에이전트에게 질문하기
```
사용자가 에이전트 캐릭터를 클릭 → 채팅 패널 오픈
  "삼성전자 지금 사도 될까?"
  → 해당 에이전트가 메모리 검색 + 다른 에이전트 의견 취합
  → 종합 답변 생성
  → 필요시 다른 에이전트를 불러서 추가 의견 제공
```

#### 3.7.2 에이전트가 사용자에게 다가오기
```
중요 발견 시 에이전트가 사용자 데스크로 이동:
  번개: (뛰어오며) "긴급! 보유 중인 LG에너지솔루션 관련 속보입니다!"
  한눈이: (걸어오며) "오후장 시장 방향이 바뀌고 있어요. 확인해주세요."
  슬기: (걸어오며) "관심종목 카카오가 매수 적정가에 진입했습니다."
  밸런스: (걸어오며) "포트폴리오 리스크가 높아지고 있어요. 조정이 필요합니다."
```

### 3.8 에이전트 시각적 배치 — 전체 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────┐
│  [헤더] OUR Paper Trading    잔고: 87,234,500원    수익률: +12.3%   │
├─────────────────────────────────────┬───────────────────────────────┤
│                                     │                               │
│   실시간 차트 (캔들스틱)             │   호가창 / 체결               │
│   ┌─────────────────────────┐      │   ┌─────────────────────┐    │
│   │  ▄▅▆▇█▇▆▅▄▃▄▅▆█▇▆     │      │   │ 매도호가 │ 매수호가 │    │
│   │  ══════════════════     │      │   │ 72,600  │         │    │
│   │  MA5 ── MA20 ── MA60   │      │   │ 72,500  │ ■■■■■   │    │
│   └─────────────────────────┘      │   │ 72,400  │ ■■■■    │    │
│                                     │   │ [현재가 72,300]     │    │
│   ┌── 에이전트 월드 ────────────┐   │   │ ■■■■   │ 72,200  │    │
│   │  🔍    💬"실적 좋은데?"     │   │   │ ■■■    │ 72,100  │    │
│   │ 한눈이 ←─── 📊 슬기       │   │   └─────────────────────┘    │
│   │  📺전광판    분석데스크     │   │                               │
│   │                             │   │   ┌── 주문 패널 ──────────┐  │
│   │  ⚡번개 ─🏃─▶ 🔍한눈이    │   │   │ [시장가][지정가][예약]  │  │
│   │  📰뉴스터미널  (뛰어가는중) │   │   │ 수량: [___]            │  │
│   │                             │   │   │ 가격: [___]            │  │
│   │  ⚖️밸런스                   │   │   │ [매수]     [매도]      │  │
│   │  📊포트폴리오보드           │   │   └──────────────────────┘  │
│   └─────────────────────────────┘   │                               │
│                                     │                               │
├─────────────────────────────────────┴───────────────────────────────┤
│  [에이전트 대화 로그] (스크롤 가능)                                   │
│  09:32 ⚡번개: "삼성전자 실적 서프라이즈! 영업이익 12조!"            │
│  09:33 ⚡번개→🔍한눈이: "반도체 섹터 전체 영향 분석해줘"             │
│  09:34 🔍한눈이→📊슬기: "외국인 수급 유입 중, 추가 상승 동력 있어"  │
│  09:35 📊슬기→⚖️밸런스: "삼성전자 매수 비중 확대 어때?"             │
│  09:36 ⚖️밸런스: "20%까지 OK, 단 섹터 전체 35% 미만 유지 권고"      │
│  ──────────────────────────────────────────────────────────────────  │
│  💡 종합 의견: 삼성전자 매수 긍정적 (신뢰도 78%) [상세 리포트 보기]  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.9 에이전트 상태 표시 시스템

각 에이전트의 현재 상태를 아이콘 + 텍스트로 실시간 표시:

```
에이전트 상태 바 (화면 상단 또는 측면):

┌────────────────────────────────────────────────────────┐
│ 🔍 한눈이: 📖 KOSPI 저항선 분석 중...                  │
│ 📊 슬기:   💬 밸런스와 삼성전자 토론 중                │
│ ⚡ 번개:   🏃 한눈이에게 속보 전달 중                  │
│ ⚖️ 밸런스: ✍️ 포트폴리오 리밸런싱 리포트 작성 중       │
└────────────────────────────────────────────────────────┘
```

### 3.10 에이전트 관계 및 성향 매트릭스

에이전트 간 상호작용 패턴과 관계가 시간이 지남에 따라 진화합니다.

| 관계 | 상호작용 패턴 | 빈도 |
|------|-------------|------|
| 번개 → 한눈이 | 뉴스 전달 후 시장 영향 분석 요청 | 매우 높음 (속보마다) |
| 한눈이 → 슬기 | 시장 동향 데이터 제공, 종목 분석 트리거 | 높음 |
| 슬기 ↔ 밸런스 | 매수/매도 의견 토론, 의견 충돌 빈번 | 높음 (가장 많은 토론) |
| 번개 → 슬기 | 종목 관련 뉴스 직접 전달 | 중간 |
| 밸런스 → 한눈이 | 시장 전체 리스크 확인 요청 | 중간 |
| 전체 | 정기 미팅 (장 시작 전, 점심, 장 마감) | 하루 3회 |

**성향 충돌 설계** (토론을 유도하기 위한 의도적 설계):
- **슬기** (공격적 투자 성향) vs **밸런스** (보수적 리스크 관리) → 자주 토론
- **번개** (속보 과대반응 경향) vs **한눈이** (냉정한 데이터 분석) → 의견 조율
- 이러한 성향 차이가 사용자에게 **다양한 관점**을 제공

### 3.11 LLM 비용 최적화 전략 (Gemini API)

> **핵심 문제**: 4개 에이전트가 10초 틱으로 Gemini 3 Pro를 사용하면 **월 $1,280** 발생.
> 계층적 모델 혼용 + 적응형 틱으로 **월 $13~$20**까지 절감 가능.

#### 3.11.1 계층적 모델 혼용 (Tiered Model Strategy)

| 작업 유형 | 모델 | 가격 (입력/출력, /1M토큰) | 이유 |
|-----------|------|--------------------------|------|
| 행동 루프 반응 판단 | **Gemini 2.5 Flash-Lite** | $0.10 / $0.40 | 단순 YES/NO 판단, 최저가 |
| 중요도 채점 | **규칙 기반** (LLM 호출 없음) | $0 | 키워드+변동폭으로 충분 |
| 에이전트 간 대화 | **Gemini 2.5 Flash** | $0.15 / $0.60 | 자연스러운 대화 품질 필요 |
| 리플렉션/통찰 생성 | **Gemini 2.5 Pro** | $1.25 / $10.00 | 고수준 추론 필요 |
| 정기 미팅/종합 리포트 | **Gemini 2.5 Pro** | $1.25 / $10.00 | 품질 중요 |
| 사용자 직접 응답 | **Gemini 2.5 Pro** | $1.25 / $10.00 | 최고 품질 제공 |

#### 3.11.2 적응형 틱 간격 (Adaptive Tick Interval)

```
고정 10초 틱 대신, 시장 상황에 따라 동적 조절:

  시장 변동성 높음 (VIX↑, 급등락):  10초 간격
  정규 장중:                         30초 간격
  장 초반/마감 직전 (09:00~09:30, 15:00~15:30): 10초 간격
  점심시간 (11:30~13:00):           60초 간격
  장외시간:                         300초 간격 또는 이벤트 기반

  → 평균 틱 간격 ~25초 → 호출 60% 감소
```

#### 3.11.3 한국어 토큰 오버헤드 대응

한국어는 영어 대비 **2~3배 토큰**을 소비합니다.

```
최적화 전략:
1. 시스템 프롬프트(페르소나, 규칙)는 영어로 작성 → 50% 절감
2. 시장 데이터는 JSON 코드로 전달:
   AS-IS: "삼성전자 현재가 72,500원, 전일대비 +1.2%, 거래량 3백만주"
   TO-BE: {"c":"005930","p":72500,"chg":1.2,"v":3000000}
3. 사용자에게 보여주는 출력만 한국어로 생성
4. Context Caching: 반복되는 시스템 프롬프트 캐싱 (75% 입력 비용 절감)
```

#### 3.11.4 예상 월간 비용

| 최적화 수준 | 일일 비용 | 월간 (22영업일) |
|------------|----------|---------------|
| 비최적화 (Gemini 3 Pro 전체) | $58.20 | **$1,280** |
| 모델 혼용만 | $4.18 | **$92** |
| 모델 혼용 + 적응형 틱 | $1.80 | **$40** |
| 전체 최적화 (캐싱+규칙필터 포함) | $0.60~$0.80 | **$13~$18** |

#### 3.11.5 Gemini API Rate Limit 대응

```
Tier 1 (유료 결제 활성화, 필수):
  - Gemini 2.5 Flash: 300 RPM, 2M TPM, 1,500 RPD
  - Gemini 2.5 Pro: 150 RPM, 1M TPM, 1,000 RPD

⚠️ Free Tier로는 운영 불가 (Gemini 3 Pro: 10 RPM, 100 RPD)
⚠️ 최소 Tier 1 유료 결제 필수, 이상적으로 Tier 2 ($250+ 누적 지출)

최적화 후 요구: ~8~15 RPM, ~1,500~2,500 RPD → Tier 1으로 충분
```

### 3.12 에이전트 메모리 관리 정책

> 메모리 스트림이 무한 증가하면 검색 성능 저하 + DB 비용 증가.
> 아카이빙 + 요약 정책 필수.

```
메모리 수명 주기:

[활성 메모리] (최근 7일)
  - Redis 캐시에 최근 메모리 유지
  - 검색 시 우선 조회
  - pgvector 임베딩 검색 가능

[아카이브 메모리] (7일~3개월)
  - Supabase DB에만 저장 (Redis에서 제거)
  - 검색 시 2차 조회 (관련성 높을 때만)
  - 주간 단위로 요약 메모리 생성 (100개 → 요약 5개)

[삭제] (3개월 이상)
  - 중요도 5 이하의 일반 관찰 삭제
  - 중요도 6 이상은 요약본만 유지
  - 리플렉션/대화 결론은 영구 보존

일일 메모리 생성량 추정 (에이전트당):
  - 관찰: ~200~400개
  - 대화: ~20~50개
  - 리플렉션: ~2~3개
  - 총: ~250~450개/일/에이전트
  - 4에이전트 × 22일 = 월 ~22,000~40,000개
```

---

## 4. 핵심 기능 상세

### 4.1 실시간 시세 동기화

#### 4.1.1 한투 OpenAPI 핵심 제한사항 (반드시 숙지)

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️  한국투자증권 OpenAPI 제한사항 (2026년 기준)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [WebSocket 제한]                                                │
│  - 세션당 최대 41종목 동시 구독 (체결+호가 합산)                 │
│  - 접속키 1개 = WebSocket 세션 1개 (1:1 매핑)                   │
│  - 확장: 다중 계좌로 세션 증가 (2계좌 = 82종목)                 │
│                                                                  │
│  [REST API Rate Limit]                                           │
│  - 실전투자: 초당 20건                                           │
│  - 모의투자: 초당 5건 ← 매우 타이트!                            │
│  - 초과 시 HTTP 429 에러                                         │
│                                                                  │
│  [분봉 데이터 제한]                                               │
│  - 분봉 조회: ★당일(오늘)만 가능★ (과거 분봉 없음)             │
│  - 1분봉만 제공 (5분/15분봉은 1분봉을 직접 가공해야 함)         │
│  - 1회 조회: 30건 (30분치), 전체 장중 데이터 = 약 13회 호출     │
│                                                                  │
│  [일봉 데이터]                                                    │
│  - 수년치 과거 데이터 조회 가능                                   │
│  - 1회 최대 100건, 연속조회(pagination)로 추가 수집              │
│                                                                  │
│  [토큰 관리]                                                      │
│  - Access Token 유효기간: 24시간                                  │
│  - 갱신 가능 주기: 6시간 (6시간 내 중복 발급 시 동일 토큰 반환)  │
│  - WebSocket 접속키: REST 토큰과 별도 발급 필요                  │
│                                                                  │
│  [뉴스/공시]                                                      │
│  - 제목(타이틀) 수준만 제공, 본문 없음                           │
│  - 본격적인 공시 분석 = DART OpenAPI 병행 필수                   │
│                                                                  │
│  [모의투자 전용 제한]                                             │
│  - 일부 API 미지원 (시세 분석, 순위 등 일부 조회 제한)           │
│  - 앱 등록 가능 계좌: 최대 2개 (실전은 89개)                     │
│  - 반드시 "모의투자 지원 여부" 확인 후 개발                      │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 제한사항 대응 전략

```
[41종목 WebSocket 제한 대응]

전략 1: 동적 구독 관리
  - 사용자가 보고 있는 종목 + 보유 종목만 실시간 구독
  - 종목 변경 시 기존 구독 해제 → 새 종목 구독
  - 우선순위: 보유종목(필수) > 현재 화면 종목 > 관심종목

전략 2: 2계좌 운영 (82종목 확장)
  - 계좌1: 사용자 보유/관심 종목 실시간 (41종목)
  - 계좌2: 시장 주요 종목 + AI 에이전트 모니터링 (41종목)

전략 3: REST 폴링 보조
  - WebSocket 외 종목은 REST API로 5~10초 간격 폴링
  - 모의투자 5건/초 제한 감안하여 쓰로틀링 필수

[분봉 데이터 당일 제한 대응]

전략: 매일 장 마감 후 1분봉 수집 → Supabase에 적재
  - 15:35 스케줄러 실행 → 당일 1분봉 전체 수집 (13회 호출)
  - Supabase에 일자별 분봉 테이블 저장
  - 3~6개월 축적 후 DL 학습 데이터로 활용
  - ⚡ 서비스 시작 초기에는 분봉 학습 데이터 부족 → 일봉 기반 모델로 시작

[REST Rate Limit 대응 (모의투자 5건/초)]

  - 요청 큐 + 쓰로틀러 구현 (200ms 간격 보장)
  - 우선순위 큐: 주문 > 시세 > 종목정보 > 기타
  - Redis에 응답 캐싱 (동일 요청 5초 내 중복 차단)
  - 종목 마스터(이름, 섹터 등)는 1일 1회만 조회 → DB 캐싱
```

#### 4.1.3 토큰 자동 갱신 시스템

```python
# 토큰 관리 전략 (의사코드)
class KISTokenManager:
    """
    - 서버 시작 시 토큰 발급
    - 만료 5분 전 자동 갱신 (23시간 55분 경과 시)
    - WebSocket 접속키는 별도 관리
    - 갱신 실패 시 3회 재시도 → 실패 시 알림
    """
    token_expiry = 24 * 60 * 60  # 24시간
    refresh_before = 5 * 60       # 만료 5분 전 갱신
    min_refresh_interval = 6 * 60 * 60  # 6시간 (중복 발급 방지)
```

#### 4.1.4 데이터 흐름 (수정)

```
한투 OpenAPI ──WebSocket──▶ FastAPI ──▶ Redis (실시간 캐시)
  (최대 41~82종목)              │              │
                                ▼              ▼
한투 OpenAPI ──REST 폴링──▶ FastAPI   Supabase Realtime ──▶ Client
  (나머지 종목, 5초 간격)       │       (포트폴리오/주문 변경 알림)
                                ▼
                          Supabase DB     FastAPI WebSocket ──▶ Client
                        (주가 히스토리)   (고빈도 시세 스트리밍)
```

**동기화 요구사항**:
- WebSocket 종목: 지연 최대 수백 ms
- REST 폴링 종목: 지연 5~10초 (허용 범위 내)
- 차트 업데이트: 틱/1분/5분/15분/30분/1시간/일봉
- 장 운영시간: 프리마켓(08:30~09:00), 정규장(09:00~15:30), 시간외(15:40~18:00)

### 4.2 트레이딩 시스템

#### 주문 유형
| 주문 유형 | 설명 | 구현 방식 |
|-----------|------|-----------|
| **시장가** | 현재가로 즉시 체결 | 실시간 체결가 기준 즉시 처리 |
| **지정가(호가)** | 원하는 가격에 주문 | 호가 매칭 엔진으로 대기/체결 |
| **예약 주문** | 특정 조건 도달 시 자동 주문 | 스케줄러 + 조건 모니터링 |
| **손절/익절** | 설정 가격 도달 시 자동 매도 | 실시간 가격 모니터링 트리거 |

#### 모의 체결 엔진
```
주문 접수 → 유효성 검증 → 잔고/자금 확인 → 체결 시뮬레이션 → 잔고 업데이트
                                                    │
                                              실제 호가/체결 데이터 기반
                                              시장가: 즉시 체결
                                              지정가: 호가 도달 시 체결
```

**체결 규칙**:
- 시장가 주문: 현재 최우선 호가로 즉시 체결 처리
- 지정가 주문: 실제 시장 체결가가 지정가에 도달하면 체결
- 미체결 주문: 장 마감 시 자동 취소 (당일 유효)
- 상한가/하한가: ±30% 가격 제한 적용
- 슬리피지: 모의투자이므로 슬리피지 없음 (실시간 체결가 기준 즉시 체결)

#### 호가 단위 테이블 (KRX 규정, 반드시 적용)

| 주가 범위 | 호가 단위 | 예시 |
|-----------|----------|------|
| ~2,000원 미만 | 1원 | 1,999 → 2,000 |
| 2,000원 ~ 5,000원 미만 | 5원 | 3,500 → 3,505 |
| 5,000원 ~ 20,000원 미만 | 10원 | 15,000 → 15,010 |
| 20,000원 ~ 50,000원 미만 | 50원 | 35,000 → 35,050 |
| 50,000원 ~ 200,000원 미만 | 100원 | 72,300 → 72,400 |
| 200,000원 ~ 500,000원 미만 | 500원 | 350,000 → 350,500 |
| 500,000원 이상 | 1,000원 | 800,000 → 801,000 |

```python
# 호가 단위 검증 함수 (구현 필수)
def get_tick_size(price: int) -> int:
    if price < 2000: return 1
    elif price < 5000: return 5
    elif price < 20000: return 10
    elif price < 50000: return 50
    elif price < 200000: return 100
    elif price < 500000: return 500
    else: return 1000

def validate_order_price(price: int) -> int:
    """주문 가격을 호가 단위에 맞게 정렬"""
    tick = get_tick_size(price)
    return (price // tick) * tick
```

#### 기업 이벤트 처리 (1차 구현 범위)

| 이벤트 | 처리 방식 | 우선순위 |
|--------|----------|---------|
| **배당금** | 배당 기준일 보유 시 현금 자동 입금 (배당락일 반영) | Phase 2 |
| **액면분할** | 보유 수량 × 분할비율, 평균단가 ÷ 분할비율 | Phase 2 |
| **유상증자** | 알림만 제공 (청약 시뮬레이션은 미지원) | Phase 3 |
| **상장폐지** | 보유 종목 강제 정리 + 손실 처리 | Phase 2 |

#### 장외시간 처리

```
[정규장 종료 후 15:30~]
- 시간외 종가 거래 (15:40~16:00): 종가 기준 체결 지원
- 시간외 단일가 (16:00~18:00): 10분 단위 단일가 매매 지원 (선택적)

[장 마감 후 에이전트 동작]
- 15:30~16:00: 장 마감 리뷰 미팅 (4명 정기 미팅)
- 16:00~17:00: 일일 리포트 작성, 리플렉션, 내일 계획 수립
- 17:00~: 에이전트 휴식 상태 (화면에 잠자는 애니메이션)
- 해외시장(미국장) 개장 시: 번개가 해외시장 동향 속보 (선택적)

[장 시작 전 에이전트 동작]
- 08:00: 에이전트 기상, 전일 해외시장 리뷰
- 08:30: 프리마켓 분석 시작
- 08:45: 장 시작 전 정기 미팅
- 09:00: 정규장 개시 → 행동 루프 활성화
```

### 4.3 모의 투자 계좌

- **초기 자본금**: 사용자 선택 (1,000만원 ~ 10억원)
- **잔고 관리**: 주문가능금액, 총 평가금액, 총 손익, 수익률
- **수수료**: 실제와 동일하게 매수 0.015%, 매도 0.015% + 세금 0.18% 적용
- **거래 내역**: 전체 거래 히스토리 저장 및 조회
- **포트폴리오**: 보유 종목, 평균 매입가, 현재가, 평가손익, 수익률

### 4.4 차트 시스템

- **차트 라이브러리**: Lightweight Charts (TradingView) 또는 Apache ECharts
- **차트 유형**: 캔들스틱, 라인, 바 차트
- **기술적 지표**:
  - 이동평균선 (MA 5/20/60/120)
  - RSI (14일)
  - MACD (12, 26, 9)
  - 볼린저밴드 (20, 2)
  - 거래량
  - 스토캐스틱
- **타임프레임**: 1분, 5분, 15분, 30분, 1시간, 일봉, 주봉, 월봉

---

## 5. 딥러닝 모델 상세

### 5.1 모델 1: 주가 등락 예측 (시계열)

| 항목 | 내용 |
|------|------|
| **모델** | LSTM + Attention / Temporal Fusion Transformer (TFT) |
| **입력** | OHLCV 데이터, 기술적 지표, 거래량, 외국인/기관 수급 |
| **출력** | 다음 N분/N일 주가 방향 (상승/하락/횡보) + 확률 |
| **학습 데이터** | 최근 3년 일봉 (KIS API) + 분봉은 매일 수집하여 축적 (※ KIS 분봉은 당일만 조회 가능) |
| **업데이트** | 매일 장 마감 후 재학습 (incremental) |

### 5.2 모델 2: 패턴 인식 / 기술적 분석

| 항목 | 내용 |
|------|------|
| **모델** | CNN (ResNet 변형) / Vision Transformer |
| **입력** | 차트 이미지 (캔들스틱 + 거래량) → 이미지 인코딩 |
| **출력** | 패턴 분류 (이중바닥, 헤드앤숄더, 삼각수렴 등 20+종) + 매매 신호 |
| **학습 데이터** | 레이블링된 차트 패턴 데이터셋 |
| **업데이트** | 주 1회 재학습 |

### 5.3 모델 3: 감성 분석 (NLP)

| 항목 | 내용 |
|------|------|
| **모델** | KoELECTRA / KoBERT Fine-tuned |
| **입력** | 뉴스 제목 + 본문, 공시 텍스트 |
| **출력** | 감성 점수 (-1.0 ~ +1.0), 영향 종목, 영향도 |
| **학습 데이터** | 증권 뉴스 + 주가 반응 매핑 데이터 |
| **업데이트** | 매일 뉴스 데이터로 지속 학습 |

### 5.4 모델 4: 포트폴리오 최적화

| 항목 | 내용 |
|------|------|
| **모델** | PPO (Proximal Policy Optimization) / A2C |
| **입력** | 현재 포트폴리오, 시장 상태, 각 종목 특성 |
| **출력** | 최적 자산 배분 비율, 리밸런싱 제안 |
| **보상 함수** | 샤프 비율 최대화 + 최대 낙폭(MDD) 최소화 |
| **업데이트** | 주 1회 환경 업데이트 후 재학습 |

### 5.5 모델 통합 파이프라인

```
시장 데이터 ──▶ 전처리 ──┬──▶ 주가 예측 모델 ──────────┐
                          ├──▶ 패턴 인식 모델 ──────────┤
뉴스 데이터 ──▶ 전처리 ──┼──▶ 감성 분석 모델 ──────────┤──▶ 앙상블 스코어
                          └──▶ 포트폴리오 최적화 ───────┘      │
                                                               ▼
                                                    AI Agent에게 전달
                                                    (Gemini 3가 해석)
                                                               │
                                                               ▼
                                                    사용자에게 리포트
```

---

## 6. 데이터베이스 설계 (Supabase + Redis)

> **인증**: Clerk 전담 (사용자 관리/로그인/세션은 Clerk에서 처리)
> **DB**: Supabase (PostgreSQL + pgvector + RLS)
> **캐시**: Redis (실시간 시세, 에이전트 상태)
>
> Clerk → Supabase 연동: Third-Party Auth Provider (네이티브 통합, 2025.3~)
> RLS에서 사용자 식별: `auth.jwt()->>'sub'` (Clerk User ID)

### 6.1 주요 테이블

```sql
-- 사용자 프로필 (Clerk에서 인증, 추가 정보만 저장)
-- ※ password_hash 불필요 (Clerk가 관리)
user_profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  clerk_user_id TEXT NOT NULL UNIQUE DEFAULT (auth.jwt()->>'sub'),
  nickname TEXT,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
)

-- 가상 계좌 (RLS: clerk_user_id 기반)
accounts (id UUID, clerk_user_id TEXT, initial_capital, balance, total_asset, created_at)

-- 보유 종목
holdings (id, account_id, stock_code, stock_name, quantity, avg_price, current_price)

-- 주문
orders (id, account_id, stock_code, order_type, side, price, quantity,
        status, filled_quantity, filled_price, created_at, filled_at)

-- 거래 내역
transactions (id, order_id, account_id, stock_code, side, price,
              quantity, fee, tax, created_at)

-- 시계열 주가 (PostgreSQL 파티셔닝 — TimescaleDB 대체)
-- ※ Supabase PG17에서 TimescaleDB 미지원, pg_partman + 월별 파티셔닝 사용
stock_prices (time TIMESTAMPTZ, stock_code, open, high, low, close, volume)
  PARTITION BY RANGE (time)  -- 월별 파티션 자동 생성

-- 분봉 데이터 (매일 장 마감 후 수집하여 적재)
stock_minutes (time TIMESTAMPTZ, stock_code, open, high, low, close, volume)
  PARTITION BY RANGE (time)

-- AI 리포트
ai_reports (id, agent_type, stock_code, report_type, content,
            confidence, created_at)

-- 에이전트 메모리 스트림 (Generative Agents 핵심, pgvector 사용)
agent_memories (id, agent_type, memory_type, content, importance_score,
                embedding VECTOR(768), related_stock_codes,
                created_at, last_accessed_at, archived_at)
-- memory_type: 'observation' | 'conversation' | 'reflection' | 'plan'
-- importance_score: 1~10 (규칙 기반 + LLM 보정)
-- embedding: Sentence-Transformers (768차원) → pgvector 코사인 검색
-- archived_at: NULL이면 활성, 날짜 있으면 아카이브

-- 종목 마스터 (1일 1회 갱신)
stock_master (stock_code, stock_name, market, sector, market_cap,
              listing_date, is_active, updated_at)

-- 에이전트 간 대화 기록
agent_conversations (id, initiator_agent, target_agent, topic,
                     conversation_json, conclusion, trigger_event,
                     created_at)
-- conversation_json: [{"speaker":"번개","text":"속보!..."},{"speaker":"한눈이","text":"..."}]

-- 에이전트 일일 계획
agent_plans (id, agent_type, plan_date, plan_json, status, created_at)
-- plan_json: [{"time":"09:00","action":"시장 개장 분석","detail":"..."},...]

-- 에이전트 리플렉션 (고수준 통찰)
agent_reflections (id, agent_type, trigger_memories, questions_json,
                   insights_json, created_at)

-- 에이전트 위치/상태 로그
agent_state_log (id, agent_type, location, action, status_emoji,
                 status_text, target_agent, created_at)

-- 뉴스
news (id, title, content, source, url, sentiment_score,
      related_stocks, published_at, crawled_at)

-- DL 모델 예측 기록
predictions (id, model_type, stock_code, prediction, confidence,
             actual_result, created_at)
```

### 6.2 Redis 구조

```
# 실시간 시세
stock:price:{code}     → { price, change, volume, ... }
stock:orderbook:{code} → { asks: [...], bids: [...] }

# 시장 지수
market:kospi           → { index, change, volume }
market:kosdaq          → { index, change, volume }

# AI 에이전트 (Generative Agents)
agent:{type}:status    → { location, action, status_emoji, status_text, timestamp }
agent:{type}:position  → { x, y, target_x, target_y, moving }
agent:{type}:alerts    → [alert1, alert2, ...]
agent:{type}:memory_importance_sum → float  (리플렉션 트리거용)
agent:conversations:active → { initiator, target, topic, messages[] }
agent:meeting:scheduled → { time, participants[], agenda }

# 사용자 (Clerk user_id 기반, 세션은 Clerk가 관리)
user:{clerk_user_id}:watchlist  → [stock_code1, stock_code2, ...]
user:{clerk_user_id}:subscriptions → [구독 중인 WebSocket 종목]

# KIS 토큰 관리
kis:token:access       → { token, expires_at }
kis:token:websocket    → { approval_key, expires_at }
```

---

## 7. API 설계

### 7.1 REST API 엔드포인트

```
# 인증 (Clerk 전담 — 별도 API 불필요)
# Clerk SDK가 프론트엔드에서 로그인/회원가입/세션 관리
# FastAPI에서는 Clerk JWT 검증만 수행 (JWKS 엔드포인트)
# → /api/auth/* 엔드포인트 불필요

# 사용자 프로필 (Clerk 인증 후 추가 정보)
GET    /api/profile              - 내 프로필 조회
PUT    /api/profile              - 프로필 수정 (닉네임, 설정)

# 계좌
GET    /api/account              - 계좌 정보 조회
POST   /api/account              - 계좌 생성 (초기 자본금 설정)
GET    /api/account/holdings     - 보유 종목 조회
GET    /api/account/history      - 거래 내역 조회

# 주문
POST   /api/orders               - 주문 접수 (시장가/지정가/예약)
DELETE /api/orders/{id}          - 주문 취소
GET    /api/orders               - 주문 목록 조회
GET    /api/orders/{id}          - 주문 상세 조회

# 시장 데이터
GET    /api/market/stocks/{code}         - 종목 정보
GET    /api/market/stocks/{code}/chart   - 차트 데이터
GET    /api/market/stocks/{code}/orderbook - 호가 데이터
GET    /api/market/indices               - 시장 지수
GET    /api/market/search?q=             - 종목 검색
GET    /api/market/rankings              - 등락률 상위/하위

# AI 에이전트 (Generative Agents)
GET    /api/agents/{type}/report         - 에이전트 리포트 조회
GET    /api/agents/{type}/alerts         - 에이전트 알림 조회
POST   /api/agents/{type}/ask           - 에이전트에게 질문
GET    /api/agents/summary               - 전체 에이전트 요약
GET    /api/agents/world                 - 에이전트 월드 상태 (위치, 행동, 상태)
GET    /api/agents/conversations         - 최근 에이전트 간 대화 목록
GET    /api/agents/conversations/{id}    - 대화 상세 내용
GET    /api/agents/{type}/memories       - 에이전트 메모리 스트림 조회
GET    /api/agents/{type}/reflections    - 에이전트 리플렉션(통찰) 조회
GET    /api/agents/{type}/plan           - 에이전트 오늘 계획 조회
GET    /api/agents/meeting/latest        - 최근 정기 미팅 내용 조회

# 뉴스
GET    /api/news                         - 최신 뉴스 목록
GET    /api/news/{stock_code}            - 종목별 뉴스
GET    /api/news/breaking                - 속보

# DL 예측
GET    /api/predictions/{stock_code}     - 종목 예측 결과
GET    /api/predictions/accuracy         - 모델 정확도 통계
```

### 7.2 WebSocket 이벤트

```
# 클라이언트 → 서버
subscribe_stock(code)        - 종목 실시간 구독
unsubscribe_stock(code)      - 종목 구독 해제
subscribe_orderbook(code)    - 호가 실시간 구독

# 서버 → 클라이언트
stock_price_update           - 실시간 시세 업데이트
orderbook_update             - 실시간 호가 업데이트
order_filled                 - 주문 체결 알림
agent_alert                  - AI 에이전트 알림
breaking_news                - 속보 알림
market_index_update          - 지수 업데이트

# 에이전트 월드 실시간 이벤트 (Generative Agents)
agent_move                   - 에이전트 이동 (from, to, speed)
agent_action_change          - 에이전트 행동 변경 (분석중, 작성중 등)
agent_conversation_start     - 에이전트 간 대화 시작
agent_conversation_message   - 대화 중 새 메시지 (실시간 말풍선)
agent_conversation_end       - 대화 종료 + 결론
agent_reflection             - 에이전트 새로운 통찰 생성
agent_approach_user          - 에이전트가 사용자에게 다가옴 (중요 알림)
agent_meeting_start          - 정기/긴급 미팅 시작
agent_meeting_end            - 미팅 종료 + 요약
agent_status_update          - 에이전트 상태 텍스트 변경
```

---

## 8. 프로젝트 디렉토리 구조

```
our-paper-trading/
├── docs/
│   ├── PLAN.md                    # 이 문서
│   └── API.md                     # API 문서
│
├── frontend/                      # Next.js 프론트엔드
│   ├── src/
│   │   ├── app/                   # App Router 페이지
│   │   │   ├── (auth)/            # 인증 관련 페이지
│   │   │   ├── trading/           # 메인 트레이딩 화면
│   │   │   ├── portfolio/         # 포트폴리오 대시보드
│   │   │   └── layout.tsx
│   │   ├── components/
│   │   │   ├── chart/             # 차트 컴포넌트
│   │   │   ├── orderbook/         # 호가창 컴포넌트
│   │   │   ├── trading/           # 주문 패널
│   │   │   ├── agents/            # AI 에이전트 UI
│   │   │   │   │   ├── AgentWorld.tsx         # 에이전트 월드 맵 (메인 컨테이너)
│   │   │   │   ├── AgentSprite.tsx       # 에이전트 스프라이트 (이동/애니메이션)
│   │   │   │   ├── AgentBubble.tsx       # 말풍선 컴포넌트
│   │   │   │   ├── AgentConversation.tsx # 에이전트 간 대화 표시
│   │   │   │   ├── AgentStatusBar.tsx    # 에이전트 상태 바
│   │   │   │   ├── AgentReport.tsx       # 상세 리포트 슬라이드 패널
│   │   │   │   ├── AgentChatPanel.tsx    # 사용자↔에이전트 대화 패널
│   │   │   │   ├── ConversationLog.tsx   # 에이전트 대화 로그 (하단)
│   │   │   │   ├── MeetingView.tsx       # 정기 미팅 화면
│   │   │   │   └── WorldMap.tsx          # 맵 배경 + 장소 정의
│   │   │   ├── news/              # 뉴스 컴포넌트
│   │   │   └── common/            # 공통 컴포넌트
│   │   ├── hooks/                 # 커스텀 훅
│   │   ├── stores/                # Zustand 스토어
│   │   ├── services/              # API 클라이언트
│   │   ├── types/                 # TypeScript 타입
│   │   └── utils/                 # 유틸리티
│   ├── public/
│   │   └── agents/                # 에이전트 캐릭터 이미지
│   ├── package.json
│   ├── next.config.js
│   ├── tailwind.config.ts
│   └── tsconfig.json
│
├── backend/                       # Python FastAPI 백엔드
│   ├── app/
│   │   ├── main.py                # FastAPI 앱 엔트리포인트
│   │   ├── config.py              # 설정
│   │   ├── api/
│   │   │   ├── routes/
│   │   │   │   ├── profile.py         # 사용자 프로필 (Clerk 연동)
│   │   │   │   ├── account.py
│   │   │   │   ├── orders.py
│   │   │   │   ├── market.py
│   │   │   │   ├── agents.py
│   │   │   │   └── news.py
│   │   │   └── dependencies.py    # Clerk JWT 검증 디펜던시
│   │   ├── core/
│   │   │   ├── trading_engine.py  # 모의 체결 엔진
│   │   │   ├── market_sync.py     # 시세 동기화
│   │   │   └── order_matching.py  # 주문 매칭
│   │   ├── services/
│   │   │   ├── kis_api.py         # 한투 OpenAPI 클라이언트
│   │   │   ├── kis_websocket.py   # 한투 WebSocket 매니저
│   │   │   ├── news_crawler.py    # 뉴스 크롤러
│   │   │   ├── dart_api.py       # DART 전자공시 API 클라이언트
│   │   │   ├── stock_master.py   # 종목 마스터 데이터 관리
│   │   │   └── notification.py    # 알림 서비스
│   │   ├── agents/
│   │   │   ├── base_agent.py      # 에이전트 베이스 클래스 (메모리/리플렉션/계획)
│   │   │   ├── memory_stream.py   # 메모리 스트림 (저장/검색/중요도)
│   │   │   ├── reflection.py      # 리플렉션 엔진 (고수준 통찰 생성)
│   │   │   ├── planner.py         # 계획 시스템 (일일/시간/분 단위)
│   │   │   ├── conversation.py    # 에이전트 간 대화 생성/관리
│   │   │   ├── behavior_loop.py   # 행동 루프 (관찰→검색→반응→행동)
│   │   │   ├── world_state.py     # 에이전트 월드 상태 (위치/행동/이동)
│   │   │   ├── trend_agent.py     # 한눈이 (동향 분석)
│   │   │   ├── advisor_agent.py   # 슬기 (투자 자문)
│   │   │   ├── news_agent.py      # 번개 (뉴스 캐치)
│   │   │   ├── portfolio_agent.py # 밸런스 (포트폴리오)
│   │   │   └── agent_manager.py   # 에이전트 오케스트레이터 (틱 관리/소집)
│   │   ├── ml/
│   │   │   ├── models/
│   │   │   │   ├── price_predictor.py    # 주가 예측 (LSTM/TFT)
│   │   │   │   ├── pattern_detector.py   # 패턴 인식 (CNN)
│   │   │   │   ├── sentiment_analyzer.py # 감성 분석 (KoBERT)
│   │   │   │   └── portfolio_optimizer.py # 포트폴리오 최적화 (RL)
│   │   │   ├── training/
│   │   │   │   ├── train_price.py
│   │   │   │   ├── train_pattern.py
│   │   │   │   ├── train_sentiment.py
│   │   │   │   └── train_portfolio.py
│   │   │   ├── data/
│   │   │   │   ├── preprocessor.py
│   │   │   │   └── feature_engineer.py
│   │   │   └── inference/
│   │   │       └── ensemble.py    # 앙상블 추론
│   │   ├── models/                # DB 모델 (Supabase/SQLAlchemy)
│   │   │   ├── user_profile.py   # Clerk 연동 프로필
│   │   │   ├── account.py
│   │   │   ├── order.py
│   │   │   ├── stock.py
│   │   │   └── news.py
│   │   └── db/
│   │       ├── supabase_client.py # Supabase 클라이언트 (service_role)
│   │       └── migrations/        # Supabase 마이그레이션
│   ├── tests/
│   ├── requirements.txt
│   └── Dockerfile
│
├── docker-compose.yml             # 개발 환경 (DB, Redis 등)
├── .env.example                   # 환경변수 템플릿
└── README.md
```

---

## 9. 구현 로드맵 (Phase별)

### Phase 1: 기반 인프라 (1~2주차)
- [ ] 프로젝트 초기 세팅 (Next.js + FastAPI + Docker)
- [ ] Clerk 인증 연동 (Next.js SDK + FastAPI JWT 검증)
- [ ] Supabase 프로젝트 설정 (Clerk 통합, RLS, pgvector, pg_partman)
- [ ] 데이터베이스 스키마 생성 및 RLS 정책 설정
- [ ] 한국투자증권 OpenAPI 연동 (인증, REST, WebSocket)
  - [ ] 토큰 자동 갱신 시스템
  - [ ] WebSocket 동적 구독 관리 (41종목 제한 대응)
  - [ ] REST API 쓰로틀러 (5건/초 대응)
- [ ] Redis 실시간 시세 캐싱 파이프라인
- [ ] 종목 마스터 데이터 수집 스케줄러
- [ ] 분봉 데이터 일일 수집 스케줄러 (장 마감 후)
- [ ] Oracle Cloud Always Free 서버 세팅 (Docker, Nginx, SSL)
- [ ] CI/CD 파이프라인 (GitHub Actions → Oracle Cloud 자동 배포)

### Phase 2: 핵심 트레이딩 (3~4주차)
- [ ] 실시간 차트 컴포넌트 (캔들스틱 + 기술적 지표)
- [ ] 호가창 UI 및 실시간 업데이트
- [ ] 모의 체결 엔진 (시장가/지정가/예약주문)
- [ ] 포트폴리오 대시보드 (보유종목, 수익률, 거래내역)
- [ ] 종목 검색 및 관심종목 기능

### Phase 3: AI 에이전트 코어 (5~7주차) — Generative Agents 아키텍처
- [ ] 메모리 스트림 엔진 구현 (저장/검색/중요도 채점/임베딩)
- [ ] 리플렉션 시스템 구현 (임계값 트리거/질문 생성/통찰 도출)
- [ ] 계획 시스템 구현 (일일 계획/시간 분해/반응적 재계획)
- [ ] 행동 루프 구현 (10초 틱: 관찰→검색→반응→행동→기억)
- [ ] 에이전트 간 대화 시스템 구현 (트리거 조건/턴제 대화/결론 도출)
- [ ] 에이전트 월드 상태 관리 (위치/이동/행동 상태)
- [ ] Gemini 3 API 연동 및 에이전트별 페르소나 프롬프트 설계
- [ ] 한눈이 (동향 분석) 에이전트 구현
- [ ] 슬기 (투자 자문) 에이전트 구현
- [ ] 번개 (뉴스 캐치) 에이전트 + 뉴스 크롤러
- [ ] 밸런스 (포트폴리오) 에이전트 구현
- [ ] 에이전트 오케스트레이터 (틱 관리/정기 미팅/긴급 소집)
- [ ] 정보 확산 메커니즘 (에이전트 간 연쇄 분석 체인)

### Phase 3.5: 에이전트 월드 UI (7~8주차)
- [ ] 에이전트 월드 맵 컴포넌트 (장소 배치/배경)
- [ ] 에이전트 스프라이트 (캐릭터 디자인/이동 애니메이션)
- [ ] 말풍선 시스템 (실시간 메시지/대화 표시)
- [ ] 에이전트 간 대화 뷰 (마주보기/말풍선 교환 애니메이션)
- [ ] 에이전트 상태 바 (현재 행동/상태 이모지)
- [ ] 대화 로그 패널 (전체 에이전트 대화 히스토리)
- [ ] 사용자↔에이전트 채팅 패널
- [ ] 정기 미팅 뷰 (4명 모여서 브리핑)
- [ ] 긴급 소집 애니메이션 (속보 시 모두 모이기)
- [ ] 에이전트가 사용자에게 다가오는 알림 UX

### Phase 4: 딥러닝 모델 (9~11주차)
- [ ] 데이터 수집 및 전처리 파이프라인
- [ ] 주가 예측 모델 (LSTM/TFT) 학습 및 배포
- [ ] 패턴 인식 모델 (CNN) 학습 및 배포
- [ ] 감성 분석 모델 (KoELECTRA) 학습 및 배포
- [ ] 포트폴리오 최적화 모델 (RL) 학습 및 배포
- [ ] 앙상블 추론 파이프라인
- [ ] AI 에이전트 ↔ DL 모델 통합

### Phase 5: 고도화 및 폴리시 (12주차~)
- [ ] 속보/알림 시스템 고도화
- [ ] 사용자 대시보드 및 통계
- [ ] 모델 성능 모니터링 및 자동 재학습
- [ ] 성능 최적화 (캐싱, 쿼리 최적화)
- [ ] UI/UX 개선 및 반응형 디자인
- [ ] 에러 처리 및 안정성 강화

---

## 10. 필수 외부 서비스 및 계정

| 서비스 | 용도 | 비용 | 비고 |
|--------|------|------|------|
| **한국투자증권 OpenAPI** | 실시간 주식 시세, 종목 정보 | 무료 | 계좌 개설 필요, 모의투자 신청 |
| **Clerk** | 사용자 인증 (로그인/회원가입) | Free: MAU 10,000 / Pro: $25/월 | Next.js + FastAPI 연동 |
| **Supabase** | PostgreSQL DB + pgvector + Realtime | Free: 500MB / Pro: $25/월 | RLS + Clerk 네이티브 통합 |
| **Google Gemini API** | AI 에이전트 LLM | Tier 1: 종량제 (~$13~92/월) | 최소 유료 Tier 필수 |
| **Redis** (Upstash 등) | 실시간 시세 캐시, 에이전트 상태 | Free: 10K cmd/일 | 또는 Docker로 셀프호스팅 |
| **DART OpenAPI** | 전자공시 (재무제표, 공시 본문) | 무료 | 금융감독원, API 키 발급 필요 |
| **Naver/Daum** | 뉴스 크롤링 | 무료 | Rate limit 준수, 저작권 주의 |

### 한투 OpenAPI 설정 필요 항목
1. 한국투자증권 계좌 개설 (모의투자용 2계좌 권장)
2. KIS Developers 포털 가입 (https://apiportal.koreainvestment.com)
3. 앱 등록 및 APP_KEY, APP_SECRET 발급 (모의투자용 별도 발급)
4. 모의투자 서비스 신청
5. WebSocket 접속키 발급 테스트

### Clerk 설정 필요 항목
1. Clerk 계정 생성 (https://clerk.com)
2. 애플리케이션 생성, Publishable Key / Secret Key 발급
3. Supabase Integration 활성화 (Third-Party Auth Provider)
4. 소셜 로그인 설정 (Google, Kakao 등)

### Supabase 설정 필요 항목
1. Supabase 프로젝트 생성 (https://supabase.com)
2. Clerk Third-Party Auth Provider 연동
3. pgvector 확장 활성화 (`CREATE EXTENSION vector;`)
4. RLS 정책 설정 (clerk_user_id 기반)
5. pg_partman 확장 활성화 (시계열 파티셔닝)

### DART OpenAPI 설정 필요 항목
1. 금융감독원 DART 포털 (https://opendart.fss.or.kr)
2. API 인증키 발급
3. 공시 검색, 재무제표 조회 API 테스트

### Supabase 용량 계획

```
[Free Plan 500MB 추정]
주가 일봉 (1행 ~100bytes):
  - 2,700종목 × 250일 × 100B = ~67MB/년
분봉 데이터 (1행 ~80bytes):
  - 100종목 × 390분 × 80B = ~3MB/일 → ~66MB/달
에이전트 메모리 (1행 ~500bytes + 768차원 벡터 ~3KB):
  - 40,000개/월 × 3.5KB = ~140MB/월

→ Free Plan으로 약 2~3개월 운영 가능
→ 프로덕션에서는 Pro Plan ($25/월, 8GB) 필수
```

---

## 11. 핵심 기술적 고려사항

### 11.1 실시간 성능
- WebSocket 연결 관리: 자동 재연결, 하트비트, 연결 풀링
- Redis Pub/Sub로 서버 간 메시지 브로커링
- 프론트엔드: requestAnimationFrame 기반 차트 업데이트로 렌더링 최적화
- 데이터 스로틀링: 초당 업데이트 횟수 제한 (UI 부하 방지)

### 11.2 데이터 정합성
- 모의 체결 시 실제 시장 데이터와의 시간 동기화 (NTP)
- 주문 처리의 원자성 보장 (DB 트랜잭션)
- 장 운영시간 외 주문 차단 로직
- 호가 단위 검증 (가격대별 상이한 호가 단위 테이블)

### 11.3 인증/보안 (Clerk + Supabase)
- **Clerk**: 사용자 인증 전담 (로그인/회원가입/세션/MFA)
  - Next.js: `@clerk/nextjs` SDK로 미들웨어 보호
  - FastAPI: `fastapi-clerk-auth` 또는 수동 JWKS 검증
  - Supabase: Third-Party Auth Provider 연동 → RLS 자동 적용
- **Supabase RLS**: 모든 사용자 데이터 테이블에 RLS 필수 활성화
  - `auth.jwt()->>'sub'` 기반 행 수준 보안
  - FastAPI → Supabase: `service_role` key 사용 시 RLS 바이패스 (주의)
- API 키 암호화 저장 (한투 OpenAPI 키, Gemini API 키)
- Rate limiting (API 호출 제한)
- 입력 값 검증 (XSS, SQL Injection 방지)
- CORS 설정 (Vercel 도메인만 허용)

### 11.4 실시간 통신 아키텍처 (WebSocket vs Supabase Realtime)

```
[FastAPI WebSocket] — 고빈도 데이터 전용
  - 실시간 주가 스트리밍 (한투 → Redis → 클라이언트)
  - 에이전트 월드 상태 업데이트 (이동, 대화, 행동)
  - 호가창 실시간 업데이트

[Supabase Realtime] — DB 변경 기반 알림
  - 주문 체결 알림 (orders 테이블 변경 감지)
  - 포트폴리오 업데이트 (holdings 테이블 변경 감지)
  - 에이전트 리포트 완성 알림 (ai_reports 테이블 변경 감지)
  - Broadcast: 속보 알림, 에이전트 대화 메시지
```

### 11.5 확장성
- 마이크로서비스 분리 가능한 모듈 구조
- DL 모델 서빙: 별도 추론 서버 분리 가능 (TorchServe/Triton)
- Supabase Pro 플랜 이상에서 DB 리플리카 지원

---

## 12. 클라우드 배포 아키텍처 (Always-On MVP)

> **목표**: PC를 꺼도 24시간 365일 서비스가 동작하도록 클라우드에 배포

### 12.1 배포 구성도

```
┌─────────────────────────────────────────────────────────────┐
│                    CLOUD (Always-On)                         │
│                                                             │
│  ┌─────────────────┐     ┌──────────────────────────────┐   │
│  │   Vercel (Free)  │     │  Oracle Cloud Always Free    │   │
│  │                  │     │  (4 OCPU Arm, 24GB RAM)      │   │
│  │  Next.js 프론트  │────▶│                              │   │
│  │  (정적 + SSR)    │     │  ┌────────────────────────┐  │   │
│  └─────────────────┘     │  │ Docker Compose          │  │   │
│                          │  │                        │  │   │
│  ┌─────────────────┐     │  │  FastAPI (백엔드 API)   │  │   │
│  │   Clerk (Free)   │     │  │  Redis (실시간 캐시)    │  │   │
│  │   사용자 인증     │     │  │  Agent Loop (4 에이전트)│  │   │
│  └─────────────────┘     │  │  WebSocket Server      │  │   │
│                          │  │  뉴스 크롤러 스케줄러   │  │   │
│  ┌─────────────────┐     │  │  분봉 수집 스케줄러     │  │   │
│  │  Supabase (Free) │     │  │  KIS Token Manager     │  │   │
│  │  PostgreSQL DB   │◀───│  │                        │  │   │
│  │  pgvector        │     │  └────────────────────────┘  │   │
│  │  Realtime        │     │                              │   │
│  └─────────────────┘     └──────────────────────────────┘   │
│                                                             │
│  ┌─────────────────┐     ┌──────────────────────────────┐   │
│  │  Gemini API      │     │  한투 OpenAPI                │   │
│  │  (종량제)        │     │  (REST + WebSocket)          │   │
│  └─────────────────┘     └──────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 12.2 서비스별 배포 위치

| 서비스 | 배포 위치 | 비용 | 항상 ON? |
|--------|-----------|------|----------|
| Next.js 프론트엔드 | **Vercel** (Free Tier) | $0/월 | O |
| 사용자 인증 | **Clerk** (Free: MAU 10K) | $0/월 | O |
| PostgreSQL + pgvector | **Supabase** (Free: 500MB) | $0/월 | O |
| FastAPI 백엔드 API | **Oracle Cloud** Always Free | $0/월 | O |
| Redis 캐시 | **Oracle Cloud** (Docker) | $0/월 | O |
| AI Agent 행동 루프 | **Oracle Cloud** (Docker) | $0/월 | O |
| WebSocket 서버 | **Oracle Cloud** (Docker) | $0/월 | O |
| 뉴스 크롤러/스케줄러 | **Oracle Cloud** (Docker) | $0/월 | O |
| KIS WebSocket 연결 | **Oracle Cloud** (Docker) | $0/월 | O |
| Gemini API | Google Cloud (종량제) | ~$13~18/월 | O |
| 한투 OpenAPI | 한국투자증권 | $0/월 | O |
| DART OpenAPI | 금융감독원 | $0/월 | O |

### 12.3 Oracle Cloud Always Free 스펙

```
[Oracle Cloud Infrastructure — Always Free Tier]
  CPU:      4 OCPU (Ampere A1, ARM 아키텍처)
  RAM:      24 GB
  Storage:  200 GB 블록 스토리지
  Network:  10 TB/월 아웃바운드
  기간:     영구 무료 (크레딧 소진 후에도 유지)
  리전:     서울 리전 사용 가능 (ap-seoul-1)

[MVP 리소스 사용 추정]
  FastAPI + Uvicorn:          ~0.5 OCPU, ~1GB RAM
  Redis:                      ~0.2 OCPU, ~0.5GB RAM
  Agent Loop (4 에이전트):    ~0.5 OCPU, ~2GB RAM
  KIS WebSocket Client:       ~0.1 OCPU, ~0.2GB RAM
  뉴스 크롤러/스케줄러:      ~0.2 OCPU, ~0.5GB RAM
  ────────────────────────────────────────────
  합계:                       ~1.5 OCPU, ~4.2GB RAM
  여유:                       2.5 OCPU, ~19.8GB RAM (DL 모델 서빙 가능)
```

### 12.4 배포 방식

```yaml
# docker-compose.prod.yml (Oracle Cloud용)
version: '3.8'
services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
      # ARM64 빌드 (Oracle Ampere A1)
      platforms: [linux/arm64]
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - KIS_APP_KEY=${KIS_APP_KEY}
      - KIS_APP_SECRET=${KIS_APP_SECRET}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
    restart: always

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always

  agent-loop:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent
      platforms: [linux/arm64]
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
      - api
    restart: always

volumes:
  redis_data:
```

### 12.5 Oracle Cloud 세팅 가이드

1. Oracle Cloud 계정 생성 (https://cloud.oracle.com)
   - 신용카드 등록 필요 (Always Free는 과금 안 됨)
   - 서울 리전(ap-seoul-1) 선택
2. Compute Instance 생성
   - Shape: VM.Standard.A1.Flex (Ampere ARM)
   - OCPU: 4, RAM: 24GB (Always Free 최대)
   - OS: Ubuntu 22.04 (aarch64)
3. 네트워크 설정
   - VCN + Public Subnet 생성
   - Security List에 포트 열기: 80, 443, 8000 (API)
   - Reserved Public IP 할당
4. 서버 초기 설정
   ```bash
   # Docker 설치
   sudo apt update && sudo apt install docker.io docker-compose-plugin -y
   sudo usermod -aG docker $USER

   # 프로젝트 배포
   git clone <repo-url>
   cd our-paper-trading
   cp .env.example .env  # 환경변수 설정
   docker compose -f docker-compose.prod.yml up -d
   ```
5. 도메인 연결 (선택)
   - Vercel: 커스텀 도메인 연결
   - Oracle Cloud: Nginx reverse proxy + Let's Encrypt SSL
6. 모니터링
   - `docker compose logs -f` 로그 확인
   - Oracle Cloud 콘솔에서 CPU/RAM 모니터링
   - Uptime 체크: UptimeRobot (무료, 5분 간격)

### 12.6 DL 모델 서빙 전략

```
[Phase 4 딥러닝 모델 배포 시]

Option A: Oracle Cloud에서 직접 서빙 (MVP 추천)
  - 여유 리소스 (2.5 OCPU, ~19GB RAM)로 경량 모델 서빙 가능
  - PyTorch CPU 추론 (ARM64 지원)
  - 배치 추론: 장 마감 후 야간에 다음날 예측 생성
  - 실시간 추론: 요청 시 모델 로드 → 예측 → 캐싱

Option B: 별도 GPU 서버 (고도화 시)
  - Google Colab Pro+ ($49.99/월): 학습 전용
  - RunPod/Vast.ai: GPU 추론 서버 (필요 시만 사용)
  - Oracle Cloud A10 GPU: $1.28/hr (Always Free 아님)
```

### 12.7 MVP 무료 운영 비용 총정리

| 항목 | 서비스 | 월 비용 |
|------|--------|---------|
| 프론트엔드 호스팅 | Vercel Free | $0 |
| 백엔드 서버 | Oracle Cloud Always Free | $0 |
| 데이터베이스 | Supabase Free (500MB) | $0 |
| 인증 | Clerk Free (MAU 10K) | $0 |
| AI LLM | Gemini API (계층적 혼용) | **~$13~18** |
| 주식 데이터 | 한투 OpenAPI | $0 |
| 공시 데이터 | DART OpenAPI | $0 |
| 모니터링 | UptimeRobot Free | $0 |
| **합계** | | **~$13~18/월** |

> **결론**: Gemini API 비용만 발생하며, 나머지 모든 인프라는 무료로 24시간 운영 가능

---

## 13. 리스크 및 대응 방안

> Oracle Cloud Always Free 관련 리스크 추가

| 리스크 | 심각도 | 영향 | 대응 방안 |
|--------|--------|------|-----------|
| **KIS WebSocket 41종목 제한** | HIGH | 다수 종목 실시간 불가 | 동적 구독 관리 + 2계좌 운영 + REST 폴링 보조 |
| **KIS 모의투자 5건/초 제한** | HIGH | API 병목 | 요청 큐 + 쓰로틀러 + Redis 캐싱 |
| **KIS 분봉 데이터 당일만** | HIGH | DL 학습 데이터 부족 | 매일 수집 → DB 적재, 초기에는 일봉 기반 |
| **Gemini API 비용 초과** | MEDIUM | 월 비용 폭등 | 계층적 모델 혼용 + 적응형 틱 + 일일 한도 |
| **Gemini Free Tier 불가** | MEDIUM | 개발 중 비용 | 최소 Tier 1 유료 결제 필수 |
| **Supabase 500MB 제한 (Free)** | MEDIUM | DB 용량 초과 | 2~3개월 내 Pro 플랜 전환 필요 |
| **TimescaleDB Supabase 미지원** | LOW | PG17 사용 불가 | pg_partman + 네이티브 파티셔닝 대체 |
| 한투 API 장애/점검 | MEDIUM | 실시간 시세 중단 | Yahoo Finance 백업, 캐시된 최근 데이터 표시 |
| DL 모델 정확도 부족 | LOW | 잘못된 추천 | 신뢰도 표시, 면책 고지, 점진적 모델 개선 |
| 뉴스 크롤링 차단 | LOW | 뉴스 기능 중단 | DART API 백업, RSS 보조, 한투 뉴스 타이틀 |
| WebSocket 연결 불안정 | MEDIUM | 시세 지연 | 자동 재연결, REST 폴백, 연결 상태 UI 표시 |
| KIS 토큰 만료 | LOW | API 호출 실패 | 자동 갱신 스케줄러 (만료 5분 전) |
| 에이전트 메모리 무한 증가 | MEDIUM | DB 비용 + 검색 느려짐 | 7일/3개월 아카이빙 + 요약 정책 |
| **Oracle Cloud 인스턴스 회수** | LOW | 서버 중단 | Idle 방지 cron job + 주간 부하 유지 |
| Oracle Cloud ARM 호환성 | LOW | 일부 패키지 미지원 | ARM64 Docker 이미지 사전 검증 |

---

## 14. 면책 및 법적 고려사항

> **중요**: 이 서비스는 모의 투자 교육 목적이며, AI의 분석과 추천은 투자 조언이 아닙니다.
> - 서비스 내 모든 AI 리포트에 "이 분석은 참고용이며 실제 투자 판단의 근거가 될 수 없습니다" 면책 문구 필수 표시
> - 금융투자업 인허가 관련 법적 검토 필요 (모의투자는 일반적으로 해당 없으나 확인 필요)
> - 뉴스 크롤링 시 저작권 및 이용약관 준수

---

*이 계획서는 프로젝트 진행에 따라 지속적으로 업데이트됩니다.*
